"""
Vue pour la cr√©ation de nouvelles demandes - VERSION CORRIG√âE
Gestion am√©lior√©e des erreurs et des cas d'√©chec
"""
import streamlit as st
from datetime import datetime, date
from controllers.auth_controller import AuthController
from controllers.demande_controller import DemandeController
from models.dropdown_options import DropdownOptionsModel
from utils.validators import validate_montant, validate_text_field

@AuthController.require_auth
def nouvelle_demande_page():
    """Page de cr√©ation d'une nouvelle demande - Version corrig√©e"""
    from views.components.header import display_header
    
    display_header()
    user_info = AuthController.get_current_user()
    st.subheader("‚ûï Nouvelle Demande")
    
    # D√©terminer le type de demande selon le r√¥le
    if user_info['role'] == 'marketing':
        type_demande = 'marketing'
        st.info("üì¢ Vous cr√©ez une demande Marketing qui sera envoy√©e aux financiers et admins")
    else:
        type_demande = 'budget'
        st.info("üí∞ Vous cr√©ez une demande Budget qui suivra le workflow de validation")
    
    # R√©cup√©rer les options avec gestion d'erreur robuste
    try:
        from views.admin_dropdown_options_view import get_valid_dropdown_options
        
        budget_options = get_valid_dropdown_options('budget')
        categorie_options = get_valid_dropdown_options('categorie')
        typologie_options = get_valid_dropdown_options('typologie_client')
        region_options = get_valid_dropdown_options('region')
        groupe_options = get_valid_dropdown_options('groupe_groupement')
        
    except Exception as e:
        st.error(f"‚ùå Erreur lors du chargement des options : {e}")
        budget_options = []
        categorie_options = []
        typologie_options = []
        region_options = []
        groupe_options = []
    
    # V√©rifier si TOUTES les cat√©gories critiques sont vides
    critical_categories_empty = (
        len(budget_options) == 0 and 
        len(categorie_options) == 0 and 
        len(typologie_options) == 0
    )
    
    # Afficher un avertissement si des options manquent
    missing_categories = []
    if not budget_options: missing_categories.append("Budget")
    if not categorie_options: missing_categories.append("Cat√©gorie")
    if not typologie_options: missing_categories.append("Typologie Client")
    if not region_options: missing_categories.append("R√©gion")
    if not groupe_options: missing_categories.append("Groupe/Groupement")
    
    if missing_categories:
        st.warning(f"‚ö†Ô∏è Options manquantes : {', '.join(missing_categories)}")
        
        # Bouton pour aller √† la page d'initialisation
        if st.button("üîß Initialiser les listes d√©roulantes automatiquement", type="primary"):
            try:
                # Tentative d'initialisation automatique
                with st.spinner("Initialisation en cours..."):
                    from models.dropdown_options import DropdownOptionsModel
                    
                    # Options par d√©faut optimis√©es
                    default_options = {
                        'budget': ['Budget Commercial', 'Budget Marketing', 'Budget Formation'],
                        'categorie': ['Animation Commerciale', 'Prospection Client', 'Formation √âquipe'],
                        'typologie_client': ['Grand Compte', 'PME/ETI', 'Particulier'],
                        'region': ['√éle-de-France', 'Auvergne-Rh√¥ne-Alpes', 'Nouvelle-Aquitaine'],
                        'groupe_groupement': ['Ind√©pendant', 'Franchise', 'Groupement Achats']
                    }
                    
                    for category, options_list in default_options.items():
                        for idx, option_label in enumerate(options_list, 1):
                            try:
                                DropdownOptionsModel.add_option(
                                    category=category,
                                    label=option_label,
                                    order_index=idx,
                                    auto_normalize=True
                                )
                            except:
                                pass  # Ignore si existe d√©j√†
                
                st.success("‚úÖ Initialisation termin√©e ! Rechargement de la page...")
                st.rerun()
            except Exception as e:
                st.error(f"‚ùå Erreur lors de l'initialisation : {e}")
                st.info("üí° Contactez l'administrateur pour initialiser les listes d√©roulantes")
    
    # Si TOUTES les cat√©gories critiques sont vides, proposer le mode d√©grad√©
    if critical_categories_empty:
        st.error("‚ö†Ô∏è Impossible de charger les options des listes d√©roulantes critiques.")
        st.info("üìÑ Les options doivent d'abord √™tre d√©finies par un administrateur.")
        
        # Afficher un formulaire simplifi√©
        st.markdown("---")
        st.markdown("### üõ†Ô∏è Mode D√©grad√© - Formulaire Simplifi√©")
        st.warning("üí° En attendant la configuration des listes d√©roulantes, vous pouvez utiliser ce formulaire simplifi√©.")
        
        _display_simplified_form(type_demande, user_info)
        return
    
    # Formulaire complet si au moins les cat√©gories critiques sont disponibles
    _display_full_form(
        type_demande, user_info, 
        budget_options, categorie_options, typologie_options, 
        region_options, groupe_options
    )

def _display_simplified_form(type_demande, user_info):
    """Affiche le formulaire simplifi√© en mode d√©grad√©"""
    with st.form("nouvelle_demande_form_simple"):
        col1, col2 = st.columns(2)
        
        with col1:
            nom_manifestation = st.text_input(
                "üìù Nom de la manifestation*", 
                placeholder="Ex: Salon du Marketing 2024"
            )
            client = st.text_input(
                "üè¢ Client*", 
                placeholder="Ex: Entreprise ABC"
            )
            lieu = st.text_input(
                "üìç Lieu*", 
                placeholder="Ex: Paris, France"
            )
        
        with col2:
            montant = st.number_input(
                "üí∞ Montant (‚Ç¨)*", 
                min_value=0.0, 
                step=50.0,
                help="Montant en euros"
            )
            date_evenement = st.date_input(
                "üìÖ Date de l'√©v√©nement*",
                value=date.today(),
                min_value=date.today()
            )
            urgence = st.selectbox(
                "üö® Urgence",
                options=['normale', 'urgent', 'critique'],
                format_func=lambda x: {
                    'normale': 'üü¢ Normale',
                    'urgent': 'üü° Urgent',
                    'critique': 'üî¥ Critique'
                }[x]
            )
        
        commentaires = st.text_area(
            "üí≠ Commentaires", 
            placeholder="Informations compl√©mentaires, justifications...",
            height=100
        )
        
        # Actions
        col1, col2 = st.columns(2)
        with col1:
            submit_simple = st.form_submit_button(
                "üì§ Cr√©er Demande Simplifi√©e", 
                use_container_width=True,
                type="primary"
            )
        with col2:
            if st.form_submit_button("‚ùå Annuler", use_container_width=True):
                from utils.session_manager import session_manager
                session_manager.set_current_page("dashboard")
                st.rerun()
    
    # Traitement du formulaire simplifi√©
    if submit_simple:
        _process_simplified_form(
            nom_manifestation, client, lieu, montant, date_evenement, 
            urgence, commentaires, type_demande, user_info
        )

def _display_full_form(type_demande, user_info, budget_options, categorie_options, 
                      typologie_options, region_options, groupe_options):
    """Affiche le formulaire complet"""
    with st.form("nouvelle_demande_form"):
        # 1. Listes d√©roulantes dynamiques
        st.markdown("### üéØ Classification de la Demande")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            # Budget avec gestion d'erreur
            if budget_options:
                budget = st.selectbox(
                    "üí∏ Budget*", 
                    options=[opt[0] for opt in budget_options],
                    format_func=lambda x: next((opt[1] for opt in budget_options if opt[0] == x), x),
                    help="Options g√©r√©es par la page admin"
                )
            else:
                budget = st.text_input("üí∏ Budget* (saisie libre)", 
                                     placeholder="Ex: Budget Commercial")
            
            # Typologie avec gestion d'erreur
            if typologie_options:
                typologie_client = st.selectbox(
                    "üè∑Ô∏è Typologie Client*", 
                    options=[opt[0] for opt in typologie_options],
                    format_func=lambda x: next((opt[1] for opt in typologie_options if opt[0] == x), x),
                    help="Options g√©r√©es par la page admin"
                )
            else:
                typologie_client = st.text_input("üè∑Ô∏è Typologie Client* (saisie libre)",
                                                placeholder="Ex: Grand Compte")
        
        with col2:
            # Cat√©gorie avec gestion d'erreur
            if categorie_options:
                categorie = st.selectbox(
                    "üìÇ Cat√©gorie*", 
                    options=[opt[0] for opt in categorie_options],
                    format_func=lambda x: next((opt[1] for opt in categorie_options if opt[0] == x), x),
                    help="Options g√©r√©es par la page admin"
                )
            else:
                categorie = st.text_input("üìÇ Cat√©gorie* (saisie libre)",
                                        placeholder="Ex: Animation Commerciale")
            
            # R√©gion avec gestion d'erreur
            if region_options:
                region = st.selectbox(
                    "üåç R√©gion*", 
                    options=[opt[0] for opt in region_options],
                    format_func=lambda x: next((opt[1] for opt in region_options if opt[0] == x), x),
                    help="Options g√©r√©es par la page admin"
                )
            else:
                region = st.text_input("üåç R√©gion* (saisie libre)",
                                      placeholder="Ex: √éle-de-France")
        
        with col3:
            # Groupe avec gestion d'erreur
            if groupe_options:
                groupe_groupement = st.selectbox(
                    "üë• Groupe/Groupement*", 
                    options=[opt[0] for opt in groupe_options],
                    format_func=lambda x: next((opt[1] for opt in groupe_options if opt[0] == x), x),
                    help="Options g√©r√©es par la page admin"
                )
            else:
                groupe_groupement = st.text_input("üë• Groupe/Groupement* (saisie libre)",
                                                 placeholder="Ex: Ind√©pendant")
            
            # Agence - champ de saisie libre
            agence = st.text_input(
                "üè¢ Agence*", 
                placeholder="Ex: Agence Paris Centre"
            )

        # 2. Champs principaux
        st.markdown("### üìã Informations Principales")
        col1, col2 = st.columns(2)
        
        with col1:
            nom_manifestation = st.text_input(
                "üìù Nom de la manifestation*", 
                placeholder="Ex: Salon du Marketing 2024"
            )
            client = st.text_input(
                "üè¢ Client*", 
                placeholder="Ex: Entreprise ABC"
            )
            date_evenement = st.date_input(
                "üìÖ Date de l'√©v√©nement*",
                value=date.today(),
                min_value=date.today()
            )
        
        with col2:
            lieu = st.text_input(
                "üìç Lieu*", 
                placeholder="Ex: Paris, France"
            )
            montant = st.number_input(
                "üí∞ Montant (‚Ç¨)*", 
                min_value=0.0, 
                step=50.0,
                help="Montant en euros"
            )
            urgence = st.selectbox(
                "üö® Urgence",
                options=['normale', 'urgent', 'critique'],
                format_func=lambda x: {
                    'normale': 'üü¢ Normale',
                    'urgent': 'üü° Urgent',
                    'critique': 'üî¥ Critique'
                }[x]
            )

        # 3. Gestion des participants (simplifi√©e pour √©viter les erreurs)
        st.markdown("### üë• Participants")
        
        demandeur_participe = st.checkbox(
            "Le demandeur participe √† l'√©v√©nement", 
            value=True
        )
        
        participants_libres = st.text_area(
            "Autres participants (texte libre)",
            placeholder="Noms et fonctions des autres participants...",
            height=80
        )
        
        # 4. Champs compl√©mentaires
        st.markdown("### üìù Informations Compl√©mentaires")
        
        col1, col2 = st.columns(2)
        with col1:
            client_enseigne = st.text_input(
                "üè™ Client/Enseigne", 
                placeholder="Nom de l'enseigne ou client"
            )
            nom_contact = st.text_input(
                "üë§ Nom Contact", 
                placeholder="Nom du contact"
            )
        
        with col2:
            mail_contact = st.text_input(
                "üìß Email Contact", 
                placeholder="contact@email.com"
            )
        
        commentaires = st.text_area(
            "üí≠ Commentaires", 
            placeholder="Informations compl√©mentaires, justifications...",
            height=100
        )
        
        # Validation en temps r√©el
        errors = []
        if nom_manifestation and not validate_text_field(nom_manifestation, min_length=3):
            errors.append("Le nom de la manifestation doit contenir au moins 3 caract√®res")
        if client and not validate_text_field(client, min_length=2):
            errors.append("Le nom du client doit contenir au moins 2 caract√®res")
        if lieu and not validate_text_field(lieu, min_length=2):
            errors.append("Le lieu doit contenir au moins 2 caract√®res")
        if montant > 0 and not validate_montant(montant):
            errors.append("Le montant doit √™tre positif et r√©aliste")
        
        if errors:
            for error in errors:
                st.error(f"‚ö†Ô∏è {error}")
        
        # Actions
        st.markdown("---")
        col1, col2, col3 = st.columns(3)
        
        with col1:
            save_draft = st.form_submit_button(
                "üíæ Sauvegarder Brouillon", 
                use_container_width=True,
                help="Sauvegarder sans soumettre"
            )
        
        with col2:
            submit_btn = st.form_submit_button(
                "üì§ Soumettre", 
                use_container_width=True,
                type="primary",
                help="Soumettre pour validation"
            )
        
        with col3:
            if st.form_submit_button("‚ùå Annuler", use_container_width=True):
                from utils.session_manager import session_manager
                session_manager.set_current_page("dashboard")
                st.rerun()
    
    # Traitement du formulaire complet
    if save_draft or submit_btn:
        _process_full_form(
            nom_manifestation, client, lieu, montant, date_evenement,
            urgence, commentaires, type_demande, user_info,
            budget, categorie, typologie_client, region, groupe_groupement, agence,
            client_enseigne, mail_contact, nom_contact,
            demandeur_participe, participants_libres,
            save_draft, submit_btn, errors
        )

def _process_simplified_form(nom_manifestation, client, lieu, montant, date_evenement, 
                           urgence, commentaires, type_demande, user_info):
    """Traite le formulaire simplifi√©"""
    if not nom_manifestation or not client or not lieu or montant <= 0:
        st.error("‚ö†Ô∏è Veuillez remplir tous les champs obligatoires (*)")
        return
    
    with st.spinner("Cr√©ation de la demande simplifi√©e en cours..."):
        try:
            success, demande_id = DemandeController.create_demande(
                user_id=AuthController.get_current_user_id(),
                type_demande=type_demande,
                nom_manifestation=nom_manifestation,
                client=client,
                date_evenement=date_evenement.strftime('%Y-%m-%d'),
                lieu=lieu,
                montant=montant,
                participants="",
                commentaires=commentaires,
                urgence=urgence,
                # Valeurs par d√©faut pour les champs manquants
                budget="non_defini",
                categorie="non_defini",
                typologie_client="non_defini",
                groupe_groupement="non_defini",
                region=user_info.get('region', 'non_defini'),
                agence="non_defini",
                client_enseigne="",
                mail_contact="",
                nom_contact="",
                demandeur_participe=True,
                participants_libres="",
                selected_participants=[]
            )
            
            if success:
                st.success("‚úÖ Demande simplifi√©e cr√©√©e avec succ√®s!")
                st.info("üí° Cette demande pourra √™tre compl√©t√©e plus tard quand les listes d√©roulantes seront configur√©es.")
                st.balloons()
                
                if st.button("‚Üê Retour au tableau de bord", type="secondary"):
                    from utils.session_manager import session_manager
                    session_manager.set_current_page("dashboard")
                    st.rerun()
            else:
                st.error("‚ùå Erreur lors de la cr√©ation de la demande")
                
        except Exception as e:
            st.error(f"‚ùå Erreur: {e}")

def _process_full_form(nom_manifestation, client, lieu, montant, date_evenement,
                      urgence, commentaires, type_demande, user_info,
                      budget, categorie, typologie_client, region, groupe_groupement, agence,
                      client_enseigne, mail_contact, nom_contact,
                      demandeur_participe, participants_libres,
                      save_draft, submit_btn, errors):
    """Traite le formulaire complet"""
    # Validation des champs obligatoires
    required_fields = {
        'nom_manifestation': nom_manifestation,
        'client': client,
        'lieu': lieu,
        'montant': montant,
        'budget': budget,
        'categorie': categorie,
        'typologie_client': typologie_client,
        'agence': agence
    }
    
    missing_fields = [name for name, value in required_fields.items() 
                     if not value or (name == 'montant' and value <= 0)]
    
    if missing_fields:
        st.error("‚ö†Ô∏è Veuillez remplir tous les champs obligatoires (*)")
        return
    
    if errors:
        st.error("‚ö†Ô∏è Veuillez corriger les erreurs avant de continuer")
        return
    
    # Cr√©er la demande
    with st.spinner("Cr√©ation de la demande en cours..."):
        try:
            success, demande_id = DemandeController.create_demande(
                user_id=AuthController.get_current_user_id(),
                type_demande=type_demande,
                nom_manifestation=nom_manifestation,
                client=client,
                date_evenement=date_evenement.strftime('%Y-%m-%d'),
                lieu=lieu,
                montant=montant,
                participants="",  # Ancien champ gard√© pour compatibilit√©
                commentaires=commentaires,
                urgence=urgence,
                budget=budget,
                categorie=categorie,
                typologie_client=typologie_client,
                groupe_groupement=groupe_groupement,
                region=region or user_info.get('region', 'non_defini'),
                agence=agence,
                client_enseigne=client_enseigne,
                mail_contact=mail_contact,
                nom_contact=nom_contact,
                demandeur_participe=demandeur_participe,
                participants_libres=participants_libres,
                selected_participants=[]  # Simplifi√© pour √©viter les erreurs
            )
        
            if success:
                if submit_btn:
                    # Soumettre imm√©diatement
                    with st.spinner("Soumission de la demande en cours..."):
                        submit_success, submit_message = DemandeController.submit_demande(
                            demande_id, AuthController.get_current_user_id()
                        )
                    
                    if submit_success:
                        st.success("‚úÖ Demande cr√©√©e et soumise avec succ√®s!")
                        st.balloons()
                        _display_success_summary(demande_id, nom_manifestation, montant, type_demande)
                    else:
                        st.error(f"‚ùå Erreur lors de la soumission: {submit_message}")
                else:
                    st.success("‚úÖ Demande sauvegard√©e en brouillon!")
                    st.info("üí° Vous pouvez la modifier et la soumettre plus tard depuis la page 'Mes Demandes'")
                
                # Bouton pour retourner au tableau de bord
                if st.button("‚Üê Retour au tableau de bord", type="secondary"):
                    from utils.session_manager import session_manager
                    session_manager.set_current_page("dashboard")
                    st.rerun()
            else:
                st.error("‚ùå Erreur lors de la cr√©ation de la demande")
                
        except Exception as e:
            st.error(f"‚ùå Erreur lors de la cr√©ation de la demande: {e}")
            st.info("üí° V√©rifiez que tous les services sont disponibles et r√©essayez")

def _display_success_summary(demande_id: int, nom_manifestation: str, montant: float, type_demande: str):
    """Affiche un r√©sum√© de la demande cr√©√©e"""
    st.markdown("---")
    st.subheader("üìã R√©sum√© de la demande")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown(f"""
        **üìù D√©tails:**
        - **ID:** #{demande_id}
        - **Manifestation:** {nom_manifestation}
        - **Montant:** {montant:,.0f}‚Ç¨
        - **Type:** {type_demande.title()}
        """)
    
    with col2:
        if type_demande == 'budget':
            st.markdown("""
            **üìã Prochaines √©tapes:**
            1. ‚è≥ Validation par le Directeur R√©gional
            2. üí∞ Validation financi√®re
            3. ‚úÖ Demande valid√©e
            """)
        else:
            st.markdown("""
            **üìã Prochaines √©tapes:**
            1. üí∞ Validation financi√®re directe
            2. ‚úÖ Demande valid√©e
            """)
